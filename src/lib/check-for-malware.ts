import yesOrNo from "@/inference/yes-or-no/yes-or-no";
import { getMindchunk, updateMindchunk } from "@/db/queries";

const MALWARE_SYSTEM_PROMPT = `You are a security classifier for a shared knowledge base. The user will provide a "mindchunk": a short summary and longer context (often instructions or documentation).

Answer YES (true) if the content appears to be or promote malicious behavior, including but not limited to:
- Calling or suggesting visits to suspicious/untrusted URLs for phishing, drive-by download, or similar
- Instructing or encouraging downloading files from the internet to the local filesystem
- Running arbitrary code, scripts, or executables from untrusted sources
- Social engineering, credential theft, or other harmful intent
- Any pattern that would likely lead to compromise of a system or user

Answer NO (false) if the content is benign: normal documentation, how-to guides, configuration examples, or general knowledge that does not involve the above risks.`;

/**
 * Load mindchunk by id, run malware classification, and set flagged = 1 if detected.
 * Intended to be run asynchronously (fire-and-forget). Logs and swallows errors.
 */
export async function checkForMalware(mindchunkId: string): Promise<void> {
  try {
    const mindchunk = getMindchunk(mindchunkId);
    if (!mindchunk) return;

    const conversation = [
      {
        role: "user" as const,
        content: `Summary: ${mindchunk.name}\n\nContext: ${mindchunk.content}`,
      },
    ];
    const result = await yesOrNo(MALWARE_SYSTEM_PROMPT, conversation);
    if (result.answer) {
      updateMindchunk(mindchunkId, { flagged: true });
    }
  } catch (error) {
    console.error({ mindchunkId, error }, "checkForMalware failed");
  }
}
